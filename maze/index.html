<script>
  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π ===
  const levels = {
    easy: {
      rings: 3,
      ringGap: 60,
      exitWidth: 50,
      exitOffsets: [0, Math.PI/2, Math.PI] // —Ä–∞–¥–∏–∞–Ω—ã
    },
    medium: {
      rings: 5,
      ringGap: 45,
      exitWidth: 35,
      exitOffsets: [0, 1.2, 2.4, 3.6, 4.8]
    },
    hard: {
      rings: 7,
      ringGap: 32,
      exitWidth: 22,
      exitOffsets: [0.3, 1.1, 2.0, 2.9, 3.8, 4.7, 5.6]
    }
  };

  let currentLevel = null;
  let ball = { x: 0, y: 0 };
  let gameActive = false;
  let gameOver = false;
  let accelerationX = 0;
  let accelerationY = 0;

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const difficultyScreen = document.getElementById('difficultyScreen');
  const gameScreen = document.getElementById('gameScreen');
  const messageEl = document.getElementById('message');
  const menuBtn = document.getElementById('menuBtn');
  const backBtn = document.getElementById('backBtn');
  const easyBtn = document.getElementById('easyBtn');
  const mediumBtn = document.getElementById('mediumBtn');
  const hardBtn = document.getElementById('hardBtn');

  // === –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" ‚Äî –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ===
  backBtn.addEventListener('click', () => {
    window.location.href = '../index.html';
  });

  // === –ö–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é" ‚Äî –∫ –≤—ã–±–æ—Ä—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===
  menuBtn.addEventListener('click', () => {
    gameActive = false;
    gameOver = false;
    difficultyScreen.classList.remove('hidden');
    gameScreen.classList.add('hidden');
  });

  // === –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===
  function startLevel(levelKey) {
    currentLevel = levels[levelKey];
    resetGame();
    difficultyScreen.classList.add('hidden');
    gameScreen.classList.remove('hidden');

    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission()
        .then(permission => {
          if (permission === 'granted') initGame();
          else messageEl.textContent = '–î–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º –∑–∞–ø—Ä–µ—â—ë–Ω.';
        })
        .catch(() => messageEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º.');
    } else {
      initGame();
    }
  }

  function initGame() {
    gameActive = true;
    gameOver = false;
    ball = { x: 0, y: 0 };
    messageEl.textContent = '–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω!';

    const maxRadius = currentLevel.rings * currentLevel.ringGap;
    const size = Math.min(window.innerWidth, window.innerHeight) * 0.9;
    canvas.width = size;
    canvas.height = size;

    window.addEventListener('devicemotion', handleMotion);
    requestAnimationFrame(gameLoop);
  }

  function resetGame() {
    gameActive = false;
    gameOver = false;
    accelerationX = 0;
    accelerationY = 0;
    window.removeEventListener('devicemotion', handleMotion);
  }

  easyBtn.addEventListener('click', () => startLevel('easy'));
  mediumBtn.addEventListener('click', () => startLevel('medium'));
  hardBtn.addEventListener('click', () => startLevel('hard'));

  // === –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ ===
  function drawMaze() {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const scale = Math.min(canvas.width, canvas.height) / (2 * currentLevel.rings * currentLevel.ringGap);

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // –†–∏—Å—É–µ–º –∫–∞–∂–¥—ã–π –∫—Ä—É–≥
    for (let i = 0; i < currentLevel.rings; i++) {
      const radius = (i + 1) * currentLevel.ringGap * scale;
      const exitAngle = currentLevel.exitOffsets[i];
      const halfExitRad = (currentLevel.exitWidth / 2) * (Math.PI / 180);

      // –°—Ç–µ–Ω–∞ –∫–æ–ª—å—Ü–∞
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 8 * scale;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();

      // –í—ã—Ö–æ–¥ ‚Äî —Ä–∞–∑—Ä—ã–≤
      ctx.strokeStyle = i === currentLevel.rings - 1 ? '#0f0' : '#0a0';
      ctx.lineWidth = 10 * scale;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, exitAngle - halfExitRad, exitAngle + halfExitRad);
      ctx.stroke();
    }

    // –®–∞—Ä–∏–∫
    if (gameActive && !gameOver) {
      ctx.fillStyle = '#ff5555';
      ctx.beginPath();
      ctx.arc(centerX + ball.x * scale, centerY + ball.y * scale, 8, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã ===
  function checkWin() {
    const outerRadius = currentLevel.rings * currentLevel.ringGap;
    const dist = Math.hypot(ball.x, ball.y);
    if (dist > outerRadius + 20) {
      win();
    }
  }

  function win() {
    gameActive = false;
    gameOver = true;
    messageEl.textContent = 'üèÜ –ü–æ–±–µ–¥–∞! –¢—ã –≤—ã—à–µ–ª –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞!';
    menuBtn.textContent = '–ú–µ–Ω—é';
  }

  // === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–æ–π ===
  function checkWallCollision() {
    const dist = Math.hypot(ball.x, ball.y);
    const angle = Math.atan2(ball.y, ball.x); // —É–≥–æ–ª —à–∞—Ä–∏–∫–∞

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–µ–∂–¥—É –∫–∞–∫–∏–º–∏ –∫–æ–ª—å—Ü–∞–º–∏ —à–∞—Ä–∏–∫
    for (let i = 0; i < currentLevel.rings; i++) {
      const innerRadius = i * currentLevel.ringGap;
      const outerRadius = (i + 1) * currentLevel.ringGap;
      const exitAngle = currentLevel.exitOffsets[i];
      const halfExitRad = (currentLevel.exitWidth / 2) * (Math.PI / 180);

      // –ï—Å–ª–∏ —à–∞—Ä–∏–∫ –≤ –∑–æ–Ω–µ —ç—Ç–æ–≥–æ –∫–æ–ª—å—Ü–∞
      if (dist >= innerRadius && dist <= outerRadius) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —É–≥–æ–ª —à–∞—Ä–∏–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤—ã—Ö–æ–¥–∞
        const diff = Math.abs(angle - exitAngle);
        const normalizedDiff = Math.min(diff, Math.PI * 2 - diff);

        if (normalizedDiff > halfExitRad) {
          // –®–∞—Ä–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–π—Ç–∏ –Ω–µ —á–µ—Ä–µ–∑ –≤—ã—Ö–æ–¥ ‚Äî –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º
          const ratio = (outerRadius - 5) / dist;
          ball.x *= ratio;
          ball.y *= ratio;
        }
        break; // –≤—ã—Ö–æ–¥–∏–º, —Ç.–∫. —à–∞—Ä–∏–∫ –≤ –æ–¥–Ω–æ–º –∫–æ–ª—å—Ü–µ
      }
    }
  }

  // === –§–∏–∑–∏–∫–∞ —à–∞—Ä–∏–∫–∞ ===
  function updateBall(deltaTime) {
    const speed = 60;
    ball.x += accelerationX * speed * deltaTime;
    ball.y -= accelerationY * speed * deltaTime;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–Ω–æ–π
    checkWallCollision();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
    checkWin();
  }

  // === –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ===
  let lastTime = 0;
  function gameLoop(timestamp) {
    const deltaTime = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    if (gameActive && !gameOver) {
      updateBall(deltaTime);
    }
    drawMaze();
    if (gameActive) requestAnimationFrame(gameLoop);
  }

  // === –°–µ–Ω—Å–æ—Ä—ã ===
  function handleMotion(event) {
    if (!gameActive) return;
    accelerationX = event.accelerationIncludingGravity?.x || 0;
    accelerationY = event.accelerationIncludingGravity?.y || 0;
  }
</script>

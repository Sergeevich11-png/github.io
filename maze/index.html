<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>–õ–∞–±–∏—Ä–∏–Ω—Ç</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #gameCanvas {
      display: block;
      background: #1a1a1a;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.2);
    }
    #difficultyScreen {
      text-align: center;
      width: 100%;
      padding: 20px;
    }
    #difficultyScreen h2 {
      margin-bottom: 20px;
      font-size: 24px;
    }
    .btn {
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 8px;
      color: white;
      font-weight: bold;
      transition: 0.2s;
    }
    #easyBtn { background: #4CAF50; }
    #mediumBtn { background: #FF9800; }
    #hardBtn { background: #F44336; }
    #menuBtn, #backBtn {
      background: #007AFF;
    }
    .hidden {
      display: none !important;
    }
    #ui {
      position: absolute;
      top: 15px;
      width: 100%;
      text-align: center;
      font-size: 16px;
      pointer-events: none;
    }
    #message {
      margin-bottom: 8px;
      padding: 0 10px;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
  <div id="difficultyScreen">
    <h2>–í—ã–±–µ—Ä–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</h2>
    <button id="easyBtn" class="btn">–õ—ë–≥–∫–∏–π</button>
    <button id="mediumBtn" class="btn">–°—Ä–µ–¥–Ω–∏–π</button>
    <button id="hardBtn" class="btn">–°–ª–æ–∂–Ω—ã–π</button>
    <br>
    <button id="backBtn" class="btn">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
  <div id="gameScreen" class="hidden">
    <div id="ui">
      <div id="message">–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω, —á—Ç–æ–±—ã –∫–∞—Ç–∞—Ç—å —à–∞—Ä–∏–∫!</div>
      <button id="menuBtn" class="btn" style="pointer-events: auto;">–ú–µ–Ω—é</button>
    </div>
    <canvas id="gameCanvas"></canvas>
  </div>

  <script>
    // === –£—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===
    const configs = {
      easy: { rings: 3, gap: 50, exitAngle: [0, Math.PI/2, Math.PI], exitWidthDeg: 40 },
      medium: { rings: 5, gap: 40, exitAngle: [0.5, 1.8, 3.0, 4.2, 5.5], exitWidthDeg: 28 },
      hard: { rings: 7, gap: 32, exitAngle: [0.3, 1.1, 2.0, 2.9, 3.8, 4.7, 5.6], exitWidthDeg: 18 }
    };

    // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
    let config = null;
    let ball = { x: 0, y: 0, radius: 6 };
    let gameActive = false;
    let gameOver = false;

    // === DOM ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const difficultyScreen = document.getElementById('difficultyScreen');
    const gameScreen = document.getElementById('gameScreen');
    const messageEl = document.getElementById('message');
    const menuBtn = document.getElementById('menuBtn');
    const backBtn = document.getElementById('backBtn');

    // === –ù–∞–≤–∏–≥–∞—Ü–∏—è ===
    backBtn.addEventListener('click', () => window.location.href = '../index.html');
    menuBtn.addEventListener('click', resetToMenu);

    function resetToMenu() {
      gameActive = false;
      gameOver = false;
      window.removeEventListener('devicemotion', handleMotion);
      difficultyScreen.classList.remove('hidden');
      gameScreen.classList.add('hidden');
    }

    // === –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã—á–∏—Å–ª–∏–º exitRad –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ===
    function prepareConfig(levelKey) {
      const cfg = { ...configs[levelKey] };
      cfg.exitRad = (cfg.exitWidthDeg / 2) * (Math.PI / 180);
      cfg.maxRadius = cfg.rings * cfg.gap;
      return cfg;
    }

    // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–∏ —Å–æ —Å—Ç–µ–Ω–∞–º–∏ ===
    function canMoveTo(x, y) {
      const r = Math.hypot(x, y);
      const angle = Math.atan2(y, x);

      // –ü–æ–±–µ–¥–∞ ‚Äî –≤—ã—Ö–æ–¥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∫–æ–ª—å—Ü–æ
      if (r > config.maxRadius + ball.radius * 1.5) {
        return 'win';
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –∫–æ–ª—å—Ü–æ
      for (let i = 0; i < config.rings; i++) {
        const inner = i * config.gap;
        const outer = (i + 1) * config.gap;
        const wallRadius = outer;

        // –í–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Å—Ç–µ–Ω–∞–º–∏ ‚Äî –æ–∫
        if (r > inner + ball.radius && r < outer - ball.radius) continue;

        // –°–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Å—Ç–µ–Ω–µ?
        if (Math.abs(r - wallRadius) <= ball.radius) {
          const exitCenter = config.exitAngle[i];
          let diff = Math.abs(angle - exitCenter);
          diff = Math.min(diff, 2 * Math.PI - diff);

          if (diff > config.exitRad) {
            return false; // –£–ø—ë—Ä—Å—è –≤ —Å—Ç–µ–Ω—É
          }
        }
      }
      return true;
    }

    // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—á–∏–∫–æ–≤ ‚Äî –û–°–ù–û–í–ù–û–ô –ú–û–ú–ï–ù–¢ ===
    function handleMotion(e) {
      if (!gameActive || gameOver) return;

      const ax = e.accelerationIncludingGravity?.x || 0;
      const ay = e.accelerationIncludingGravity?.y || 0;

      // –ú–∞—Å—à—Ç–∞–± –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
      const sensitivity = config.maxRadius * 0.22; // –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
      const targetX = ax * sensitivity;
      const targetY = -ay * sensitivity;

      // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è
      const oldX = ball.x;
      const oldY = ball.y;

      // –ü–ª–∞–≤–Ω–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (–∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è ‚Äî —É–±–∏—Ä–∞–µ—Ç —Ä—ã–≤–∫–∏)
      const smooth = 0.5; // 0.3‚Äì0.7 ‚Äî –±–∞–ª–∞–Ω—Å –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
      const newX = oldX + (targetX - oldX) * smooth;
      const newY = oldY + (targetY - oldY) * smooth;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π
      const result = canMoveTo(newX, newY);
      if (result === 'win') {
        ball.x = newX;
        ball.y = newY;
        gameActive = false;
        gameOver = true;
        messageEl.textContent = 'üèÜ –ü–æ–±–µ–¥–∞! –¢—ã –≤—ã—à–µ–ª –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞!';
        menuBtn.textContent = '–ú–µ–Ω—é';
      } else if (result === true) {
        ball.x = newX;
        ball.y = newY;
      }
      // –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å—Å—è ‚Äî –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ –º–µ—Å—Ç–µ (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
    }

    // === –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ===
    function draw() {
      const size = Math.min(window.innerWidth, window.innerHeight) * 0.94;
      canvas.width = canvas.height = size;
      const cx = canvas.width / 2;
      const cy = canvas.height / 2;
      const scale = size / (2 * config.maxRadius);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // –°—Ç–µ–Ω—ã ‚Äî —Ä–∏—Å—É–µ–º –∫–æ–ª—å—Ü–∞ —Å —Ä–∞–∑—Ä—ã–≤–∞–º–∏
      ctx.lineWidth = 12 * scale;
      ctx.strokeStyle = '#aaa';

      for (let i = 0; i < config.rings; i++) {
        const r = (i + 1) * config.gap * scale;
        const exitCenter = config.exitAngle[i];
        const halfExit = config.exitRad;

        ctx.beginPath();
        ctx.arc(cx, cy, r, exitCenter + halfExit, exitCenter - halfExit + 2 * Math.PI);
        ctx.stroke();
      }

      // –®–∞—Ä–∏–∫
      if (!gameOver) {
        ctx.fillStyle = '#ff4444';
        ctx.beginPath();
        ctx.arc(cx + ball.x * scale, cy + ball.y * scale, ball.radius * scale, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // === –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ‚Äî –¢–û–õ–¨–ö–û –û–¢–†–ò–°–û–í–ö–ê ===
    function loop() {
      if (gameActive || gameOver) {
        draw();
        requestAnimationFrame(loop);
      }
    }

    // === –ó–∞–ø—É—Å–∫ —É—Ä–æ–≤–Ω—è ===
    function start(levelKey) {
      config = prepareConfig(levelKey);
      const radiusMap = { easy: 8, medium: 6, hard: 5 };
      ball = { x: 0, y: 0, radius: radiusMap[levelKey] };
      gameActive = false;
      gameOver = false;
      messageEl.textContent = '–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω, —á—Ç–æ–±—ã –∫–∞—Ç–∞—Ç—å —à–∞—Ä–∏–∫!';
      menuBtn.textContent = '–ú–µ–Ω—é';

      const size = Math.min(window.innerWidth, window.innerHeight) * 0.94;
      canvas.width = canvas.height = size;

      difficultyScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');

      // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ iOS
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(permission => {
            if (permission === 'granted') {
              gameActive = true;
              window.addEventListener('devicemotion', handleMotion);
              requestAnimationFrame(loop);
            } else {
              messageEl.textContent = '–†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.';
            }
          })
          .catch(() => {
            messageEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º.';
          });
      } else {
        // Android / –¥–µ—Å–∫—Ç–æ–ø ‚Äî —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º
        gameActive = true;
        window.addEventListener('devicemotion', handleMotion);
        requestAnimationFrame(loop);
      }
    }

    // === –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===
    document.getElementById('easyBtn').addEventListener('click', () => start('easy'));
    document.getElementById('mediumBtn').addEventListener('click', () => start('medium'));
    document.getElementById('hardBtn').addEventListener('click', () => start('hard'));
  </script>
</body>
</html>

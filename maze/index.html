<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>–õ–∞–±–∏—Ä–∏–Ω—Ç</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #gameCanvas {
      display: block;
      background: #222;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.3);
    }
    #difficultyScreen {
      text-align: center;
      width: 100%;
    }
    #difficultyScreen h2 {
      margin-bottom: 20px;
      font-size: 24px;
    }
    .btn {
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
      color: white;
    }
    #easyBtn { background: #4CAF50; }
    #mediumBtn { background: #FF9800; }
    #hardBtn { background: #F44336; }
    #menuBtn, #backBtn {
      background: #007AFF;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
  <div id="difficultyScreen">
    <h2>–í—ã–±–µ—Ä–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</h2>
    <button id="easyBtn" class="btn">–õ—ë–≥–∫–∏–π</button>
    <button id="mediumBtn" class="btn">–°—Ä–µ–¥–Ω–∏–π</button>
    <button id="hardBtn" class="btn">–°–ª–æ–∂–Ω—ã–π</button>
    <br>
    <button id="backBtn" class="btn">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
  <div id="gameScreen" class="hidden">
    <div id="ui" style="position:absolute;top:15px;text-align:center;width:100%;font-size:16px;">
      <div id="message">–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω, —á—Ç–æ–±—ã –∫–∞—Ç–∞—Ç—å —à–∞—Ä–∏–∫!</div>
      <button id="menuBtn" class="btn">–ú–µ–Ω—é</button>
    </div>
    <canvas id="gameCanvas"></canvas>
  </div>

  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π ===
    const levels = {
      easy: {
        rings: 3,
        ringGap: 60,
        exitWidth: 50,
        exitOffsets: [0, Math.PI/2, Math.PI],
        ballSize: 5.5
      },
      medium: {
        rings: 5,
        ringGap: 45,
        exitWidth: 35,
        exitOffsets: [0, 1.2, 2.4, 3.6, 4.8],
        ballSize: 4.0
      },
      hard: {
        rings: 7,
        ringGap: 32,
        exitWidth: 20,
        exitOffsets: [0.3, 1.1, 2.0, 2.9, 3.8, 4.7, 5.6],
        ballSize: 3.0
      }
    };

    let currentLevel = null;
    let ball = { x: 0, y: 0 };
    let gameActive = false;
    let gameOver = false;
    let accelerationX = 0;
    let accelerationY = 0;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const difficultyScreen = document.getElementById('difficultyScreen');
    const gameScreen = document.getElementById('gameScreen');
    const messageEl = document.getElementById('message');
    const menuBtn = document.getElementById('menuBtn');
    const backBtn = document.getElementById('backBtn');
    const easyBtn = document.getElementById('easyBtn');
    const mediumBtn = document.getElementById('mediumBtn');
    const hardBtn = document.getElementById('hardBtn');

    // === –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" ‚Äî –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ===
    backBtn.addEventListener('click', () => {
      window.location.href = '../index.html';
    });

    // === –ö–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é" ‚Äî –∫ –≤—ã–±–æ—Ä—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===
    menuBtn.addEventListener('click', () => {
      gameActive = false;
      gameOver = false;
      difficultyScreen.classList.remove('hidden');
      gameScreen.classList.add('hidden');
    });

    // === –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===
    function startLevel(levelKey) {
      currentLevel = levels[levelKey];
      resetGame();
      difficultyScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');

      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(permission => {
            if (permission === 'granted') initGame();
            else messageEl.textContent = '–î–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º –∑–∞–ø—Ä–µ—â—ë–Ω.';
          })
          .catch(() => messageEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º.');
      } else {
        initGame();
      }
    }

    function initGame() {
      gameActive = true;
      gameOver = false;
      ball = { x: 0, y: 0 };
      messageEl.textContent = '–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω!';

      const size = Math.min(window.innerWidth, window.innerHeight) * 0.92;
      canvas.width = size;
      canvas.height = size;

      window.addEventListener('devicemotion', handleMotion);
      requestAnimationFrame(gameLoop);
    }

    function resetGame() {
      gameActive = false;
      gameOver = false;
      accelerationX = 0;
      accelerationY = 0;
      window.removeEventListener('devicemotion', handleMotion);
    }

    easyBtn.addEventListener('click', () => startLevel('easy'));
    mediumBtn.addEventListener('click', () => startLevel('medium'));
    hardBtn.addEventListener('click', () => startLevel('hard'));

    // === –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ ===
    function drawMaze() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const scale = Math.min(canvas.width, canvas.height) / (2 * currentLevel.rings * currentLevel.ringGap);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // –†–∏—Å—É–µ–º –∫–∞–∂–¥—ã–π –∫—Ä—É–≥
      for (let i = 0; i < currentLevel.rings; i++) {
        const radius = (i + 1) * currentLevel.ringGap * scale;
        const exitAngle = currentLevel.exitOffsets[i];
        const halfExitRad = (currentLevel.exitWidth / 2) * (Math.PI / 180);

        // –°—Ç–µ–Ω–∞ –∫–æ–ª—å—Ü–∞
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 8 * scale;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.stroke();

        // –í—ã—Ö–æ–¥ ‚Äî —Ä–∞–∑—Ä—ã–≤
        ctx.strokeStyle = i === currentLevel.rings - 1 ? '#0f0' : '#0a0';
        ctx.lineWidth = 10 * scale;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, exitAngle - halfExitRad, exitAngle + halfExitRad);
        ctx.stroke();
      }

      // –®–∞—Ä–∏–∫
      if (gameActive && !gameOver) {
        ctx.fillStyle = '#ff4444';
        ctx.beginPath();
        ctx.arc(centerX + ball.x * scale, centerY + ball.y * scale, currentLevel.ballSize * scale, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã ===
    function checkWin() {
      const outerRadius = currentLevel.rings * currentLevel.ringGap;
      const dist = Math.hypot(ball.x, ball.y);
      if (dist > outerRadius + 15) {
        win();
      }
    }

    function win() {
      gameActive = false;
      gameOver = true;
      messageEl.textContent = 'üèÜ –ü–æ–±–µ–¥–∞! –¢—ã –≤—ã—à–µ–ª –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞!';
      menuBtn.textContent = '–ú–µ–Ω—é';
    }

    // === –ñ–Å–°–¢–ö–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–æ–π ===
    function checkWallCollision() {
      const dist = Math.hypot(ball.x, ball.y);
      const angle = Math.atan2(ball.y, ball.x);

      for (let i = 0; i < currentLevel.rings; i++) {
        const inner = i * currentLevel.ringGap;
        const outer = (i + 1) * currentLevel.ringGap;
        const exitAngle = currentLevel.exitOffsets[i];
        const halfExit = (currentLevel.exitWidth / 2) * (Math.PI / 180);

        if (dist >= inner && dist <= outer) {
          let diff = Math.abs(angle - exitAngle);
          if (diff > Math.PI) diff = 2 * Math.PI - diff;

          if (diff > halfExit) {
            // –®–∞—Ä–∏–∫ –∑–∞—à—ë–ª –Ω–µ —á–µ—Ä–µ–∑ –≤—ã—Ö–æ–¥ ‚Äî –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã
            const safeDist = outer - currentLevel.ballSize;
            if (dist > safeDist) {
              const ratio = safeDist / dist;
              ball.x *= ratio;
              ball.y *= ratio;
            }
          }
          break;
        }
      }
    }

    // === –§–∏–∑–∏–∫–∞ —à–∞—Ä–∏–∫–∞ ===
    function updateBall(deltaTime) {
      const speed = 65;
      ball.x += accelerationX * speed * deltaTime;
      ball.y -= accelerationY * speed * deltaTime;

      checkWallCollision();
      checkWin();
    }

    // === –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ===
    let lastTime = 0;
    function gameLoop(timestamp) {
      const deltaTime = (timestamp - lastTime) / 1000;
      lastTime = timestamp;

      if (gameActive && !gameOver) {
        updateBall(deltaTime);
      }
      drawMaze();
      if (gameActive) requestAnimationFrame(gameLoop);
    }

    // === –°–µ–Ω—Å–æ—Ä—ã ===
    function handleMotion(event) {
      if (!gameActive) return;
      accelerationX = event.accelerationIncludingGravity?.x || 0;
      accelerationY = event.accelerationIncludingGravity?.y || 0;
    }
  </script>
</body>
</html>

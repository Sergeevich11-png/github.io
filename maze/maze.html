<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>–õ–∞–±–∏—Ä–∏–Ω—Ç</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #gameCanvas {
      display: block;
      background: #222;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.3);
    }
    #ui {
      position: absolute;
      top: 20px;
      text-align: center;
      width: 100%;
      font-size: 18px;
      padding: 0 20px;
    }
    #startBtn {
      padding: 12px 30px;
      font-size: 20px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 20px;
    }
    #startBtn:hover {
      background: #0056cc;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="ui">
    <div id="message">–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω, —á—Ç–æ–±—ã –∫–∞—Ç–∞—Ç—å —à–∞—Ä–∏–∫!</div>
    <button id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  </div>
  <canvas id="gameCanvas"></canvas>

  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const RADIUS = Math.min(window.innerWidth, window.innerHeight) * 0.4;
    const BALL_RADIUS = 12;
    const WALL_WIDTH = 20;
    const EXIT_SIZE = 40; // —à–∏—Ä–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    const EXIT_ANGLE = 0; // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ (–≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö, 0 = –≤–ø—Ä–∞–≤–æ)

    // –°–æ—Å—Ç–æ—è–Ω–∏—è
    let ball = { x: 0, y: 0 }; // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
    let gameActive = false;
    let gameOver = false;
    let accelerationX = 0;
    let accelerationY = 0;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ui = document.getElementById('ui');
    const message = document.getElementById('message');
    const startBtn = document.getElementById('startBtn');

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º canvas
    function resize() {
      const size = RADIUS * 2;
      canvas.width = size;
      canvas.height = size;
    }
    resize();
    window.addEventListener('resize', resize);

    // –ü—Ä–æ—Å—Ç–æ–π "–ª–∞–±–∏—Ä–∏–Ω—Ç": –∫–æ–ª—å—Ü–æ —Å –æ–¥–Ω–∏–º –≤—ã—Ö–æ–¥–æ–º
    function drawMaze() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      // –§–æ–Ω
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // –ù–∞—Ä–∏—Å—É–µ–º –∫–æ–ª—å—Ü–æ ‚Äî —Å—Ç–µ–Ω—É –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
      ctx.strokeStyle = '#444';
      ctx.lineWidth = WALL_WIDTH;
      ctx.beginPath();
      ctx.arc(centerX, centerY, RADIUS - WALL_WIDTH / 2, 0, Math.PI * 2);
      ctx.stroke();

      // –ù–∞—Ä–∏—Å—É–µ–º –≤—ã—Ö–æ–¥ (—Ä–∞–∑—Ä—ã–≤ –≤ –∫–æ–ª—å—Ü–µ)
      const startAngle = EXIT_ANGLE - (EXIT_SIZE * Math.PI / 180) / 2;
      const endAngle = EXIT_ANGLE + (EXIT_SIZE * Math.PI / 180) / 2;

      ctx.strokeStyle = '#0f0';
      ctx.lineWidth = WALL_WIDTH + 4;
      ctx.beginPath();
      ctx.arc(centerX, centerY, RADIUS - WALL_WIDTH / 2, startAngle, endAngle);
      ctx.stroke();

      // –®–∞—Ä–∏–∫
      if (gameActive && !gameOver) {
        ctx.fillStyle = '#ff5555';
        ctx.beginPath();
        ctx.arc(centerX + ball.x, centerY + ball.y, BALL_RADIUS, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –¥–æ—Å—Ç–∏–≥ –ª–∏ —à–∞—Ä–∏–∫ –≤—ã—Ö–æ–¥–∞
    function checkWin() {
      const distFromCenter = Math.hypot(ball.x, ball.y);
      const angle = Math.atan2(ball.y, ball.x); // —É–≥–æ–ª —à–∞—Ä–∏–∫–∞
      const angleDiff = Math.abs(angle - EXIT_ANGLE);
      const normalizedDiff = Math.min(angleDiff, Math.PI * 2 - angleDiff) * (180 / Math.PI);

      if (distFromCenter >= RADIUS - WALL_WIDTH / 2 - BALL_RADIUS &&
          normalizedDiff <= EXIT_SIZE / 2 + 5) {
        win();
      }
    }

    function win() {
      gameActive = false;
      gameOver = true;
      message.textContent = 'üèÜ –¢—ã –ø–æ–±–µ–¥–∏–ª! –ú–æ–ª–æ–¥–µ—Ü!';
      startBtn.textContent = '–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞';
      startBtn.classList.remove('hidden');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —à–∞—Ä–∏–∫–∞
    function updateBall(deltaTime) {
      // –ü—Ä–æ—Å—Ç–∞—è —Ñ–∏–∑–∏–∫–∞: —É—Å–∫–æ—Ä–µ–Ω–∏–µ ‚Üí —Å–∫–æ—Ä–æ—Å—Ç—å ‚Üí –ø–æ–∑–∏—Ü–∏—è
      const speedFactor = 80; // —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      ball.x += accelerationX * speedFactor * deltaTime;
      ball.y -= accelerationY * speedFactor * deltaTime; // Y –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω

      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
      const maxDist = RADIUS - WALL_WIDTH / 2 - BALL_RADIUS;
      const currentDist = Math.hypot(ball.x, ball.y);
      if (currentDist > maxDist) {
        // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –æ—Ç —Å—Ç–µ–Ω—ã
        const ratio = maxDist / currentDist;
        ball.x *= ratio;
        ball.y *= ratio;
      }
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
    let lastTime = 0;
    function gameLoop(timestamp) {
      const deltaTime = (timestamp - lastTime) / 1000;
      lastTime = timestamp;

      if (gameActive && !gameOver) {
        updateBall(deltaTime);
        checkWin();
      }

      drawMaze();
      if (gameActive) requestAnimationFrame(gameLoop);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ–Ω—Å–æ—Ä–æ–≤
    function handleMotion(event) {
      if (!gameActive) return;

      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      accelerationX = event.accelerationIncludingGravity?.x || event.acceleration.x || 0;
      accelerationY = event.accelerationIncludingGravity?.y || event.acceleration.y || 0;
    }

    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ iOS
    async function startGame() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceMotionEvent.requestPermission();
          if (permission !== 'granted') {
            message.textContent = '–ù—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ–Ω—Å–æ—Ä–∞–º!';
            return;
          }
        } catch (err) {
          message.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–Ω—Å–æ—Ä–∞–º.';
          console.error(err);
          return;
        }
      }

      // –ó–∞–ø—É—Å–∫
      gameActive = true;
      gameOver = false;
      ball = { x: 0, y: 0 };
      message.textContent = '–ù–∞–∫–ª–æ–Ω—è–π —Ç–µ–ª–µ—Ñ–æ–Ω!';
      startBtn.classList.add('hidden');
      window.addEventListener('devicemotion', handleMotion);
      requestAnimationFrame(gameLoop);
    }

    startBtn.addEventListener('click', startGame);
  </script>
</body>
</html>

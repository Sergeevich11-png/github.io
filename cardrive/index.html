<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Гонки — 1 Круг</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
    body {
      overflow: hidden;
      background: #000;
      touch-action: none;
      color: white;
    }
    #main-menu {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      z-index: 10;
    }
    #main-menu.hidden { display: none; }
    #main-menu h1 {
      font-size: 32px;
      margin-bottom: 40px;
      text-align: center;
      color: #4cc9f0;
    }
    .btn {
      width: 220px;
      height: 60px;
      margin: 12px 0;
      font-size: 20px;
      font-weight: bold;
      background: #4361ee;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover, .btn:active { background: #3a56d4; }
    #game-canvas {
      display: block;
      background: #111;
    }
    #pause-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }
    #controls {
      position: absolute;
      bottom: 25px;
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 0 20px;
      z-index: 10;
    }
    .ctrl-btn {
      width: 85px;
      height: 85px;
      background: rgba(0, 180, 255, 0.85);
      border: none;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px 35px;
      border-radius: 16px;
      font-size: 28px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
      text-align: center;
      transition: opacity 0.3s;
    }
    #orientation-blocker {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #0d0d1a;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      color: #f8f9fa;
    }
    #orientation-blocker.active { display: flex; }
    #orientation-blocker p {
      font-size: 22px;
      text-align: center;
      max-width: 80%;
      margin-bottom: 30px;
      line-height: 1.4;
    }
    #orientation-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<!-- МЕНЮ -->
<div id="main-menu">
  <h1>ГОНКИ: 1 КРУГ</h1>
  <button id="btn-start" class="btn">1 круг</button>
  <button id="btn-exit" class="btn">Выход</button>
</div>

<!-- ПОВОРОТ ЭКРАНА -->
<div id="orientation-blocker">
  <div id="orientation-icon">↔️</div>
  <p>Поверните устройство в альбомную ориентацию для начала гонки</p>
</div>

<!-- ИГРА -->
<canvas id="game-canvas"></canvas>
<button id="pause-btn">≡</button>
<div id="controls">
  <button id="btn-brake" class="ctrl-btn">Тормоз</button>
  <button id="btn-gas" class="ctrl-btn">Газ</button>
</div>
<div id="message">ФИНИШ!</div>

<script>
// === DOM ===
const mainMenu = document.getElementById('main-menu');
const blocker = document.getElementById('orientation-blocker');
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
const pauseBtn = document.getElementById('pause-btn');
const gasBtn = document.getElementById('btn-gas');
const brakeBtn = document.getElementById('btn-brake');
const messageEl = document.getElementById('message');

let isGas = false, isBrake = false;
let gyroActive = false;
let targetSteering = 0; // от -1 до 1
let currentSteering = 0;

let gameState = 'menu'; // 'menu', 'playing', 'finished'
let raceStarted = false;

// === ИГРОВЫЕ ПАРАМЕТРЫ ===
const trackRadius = 200;
const trackWidth = 40;
const centerX = 0, centerY = 0;

const player = {
  angle: 0,
  speed: 0,
  lapDone: false,
  color: '#ff3333'
};

const ai = {
  angle: -0.1, // немного позади
  speed: 0.035, // радиан/мс
  lapDone: false,
  color: '#33ff33'
};

// === КНОПКИ ===
document.getElementById('btn-start').addEventListener('click', () => {
  mainMenu.classList.add('hidden');
  blocker.classList.add('active');
  checkOrientation();
});

document.getElementById('btn-exit').addEventListener('click', () => {
  window.location.href = 'https://sergeevich11-png.github.io/github.io/';
});

pauseBtn.addEventListener('click', () => {
  if (gameState === 'playing') {
    gameState = 'menu';
    mainMenu.classList.remove('hidden');
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    document.getElementById('controls').style.display = 'none';
  }
});

const bindButton = (el, down, up) => {
  el.addEventListener('touchstart', down);
  el.addEventListener('mousedown', down);
  const end = () => up();
  el.addEventListener('touchend', end);
  el.addEventListener('mouseup', end);
  el.addEventListener('mouseleave', end);
};
bindButton(gasBtn, () => isGas = true, () => isGas = false);
bindButton(brakeBtn, () => isBrake = true, () => isBrake = false);

// === ГИРОСКОП ===
if (typeof DeviceOrientationEvent !== 'undefined') {
  window.addEventListener('deviceorientation', (e) => {
    if (!gyroActive || gameState !== 'playing') return;
    if (e.gamma !== null) {
      targetSteering = Math.max(-1, Math.min(1, e.gamma / 90));
    }
  }, { passive: true });

  // Запрос разрешения на iOS
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    document.body.addEventListener('click', () => {
      DeviceOrientationEvent.requestPermission().then(permission => {
        if (permission === 'granted') gyroActive = true;
      }).catch(console.warn);
    }, { once: true });
  } else {
    gyroActive = true;
  }
} else {
  gyroActive = true; // эмуляция на ПК: управление мышью или без гироскопа
}

// === ОРИЕНТАЦИЯ ===
function checkOrientation() {
  const isLandscape = window.innerWidth > window.innerHeight;
  if (isLandscape && gameState !== 'playing') {
    blocker.classList.remove('active');
    startGame();
  } else {
    setTimeout(checkOrientation, 300);
  }
}

window.addEventListener('resize', () => {
  if (gameState === 'playing') {
    resizeCanvas();
  } else {
    checkOrientation();
  }
});

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

// === ЗАПУСК ===
function startGame() {
  if (gameState === 'playing') return;
  gameState = 'playing';

  canvas.style.display = 'block';
  pauseBtn.style.display = 'block';
  document.getElementById('controls').style.display = 'flex';

  // Сброс
  player.angle = 0;
  player.speed = 0;
  player.lapDone = false;
  ai.angle = -0.1;
  ai.lapDone = false;
  raceStarted = false;

  resizeCanvas();
  lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}

// === ОСНОВНОЙ ЦИКЛ ===
let lastTime = 0;

function gameLoop(timestamp) {
  if (gameState !== 'playing') return;

  const delta = Math.min((timestamp - lastTime) / 16, 2); // ~60fps cap
  lastTime = timestamp;

  // Обновление
  updatePlayer(delta);
  updateAI(delta);
  checkLap();

  // Рендер
  render();

  requestAnimationFrame(gameLoop);
}

function updatePlayer(delta) {
  // Плавное рулевое управление
  currentSteering += (targetSteering - currentSteering) * 0.2;

  // Угол поворота
  player.angle += currentSteering * 0.02 * delta;

  // Скорость
  if (isGas) player.speed += 0.3 * delta;
  if (isBrake) player.speed -= 0.4 * delta;
  if (!isGas && !isBrake) player.speed *= 0.95;
  player.speed = Math.max(-3, Math.min(player.speed, 8));

  // Проверка старта гонки
  if (!raceStarted && Math.abs(player.speed) > 0.5) {
    raceStarted = true;
  }
}

function updateAI(delta) {
  if (ai.lapDone || !raceStarted) return;
  ai.angle += ai.speed * delta;
}

function checkLap() {
  // Угол финиша — 0 (или 2π)
  const normalizeAngle = (a) => ((a % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
  const playerNorm = normalizeAngle(player.angle);
  const aiNorm = normalizeAngle(ai.angle);

  const inFinishZone = (a) => a < 0.2 || a > Math.PI * 2 - 0.2;

  if (raceStarted && !player.lapDone && inFinishZone(playerNorm)) {
    player.lapDone = true;
    if (!ai.lapDone) {
      showMessage("Вы победили!");
    }
  }

  if (raceStarted && !ai.lapDone && inFinishZone(aiNorm)) {
    ai.lapDone = true;
    if (!player.lapDone) {
      showMessage("ИИ пришёл первым!");
    }
  }
}

function showMessage(text) {
  messageEl.textContent = text;
  messageEl.style.opacity = '1';
  gameState = 'finished';
  setTimeout(() => {
    messageEl.style.opacity = '0';
    // Через 3 сек — возврат в меню
    setTimeout(() => {
      mainMenu.classList.remove('hidden');
      canvas.style.display = 'none';
      pauseBtn.style.display = 'none';
      document.getElementById('controls').style.display = 'none';
    }, 3000);
  }, 10);
}

// === РЕНДЕР ===
function render() {
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const camX = w / 2;
  const camY = h / 2;

  // Трасса (кольцо)
  ctx.strokeStyle = '#333';
  ctx.lineWidth = trackWidth * 2;
  ctx.beginPath();
  ctx.arc(camX, camY, trackRadius, 0, Math.PI * 2);
  ctx.stroke();

  // Старт/финиш
  ctx.save();
  ctx.translate(camX, camY);
  ctx.rotate(0);
  ctx.fillStyle = '#ff0000';
  ctx.fillRect(trackRadius - 2, -3, 4, 6);
  ctx.restore();

  // Машины
  drawCar(camX + Math.cos(player.angle) * trackRadius, camY + Math.sin(player.angle) * trackRadius, player.angle + Math.PI / 2, player.color);
  drawCar(camX + Math.cos(ai.angle) * trackRadius, camY + Math.sin(ai.angle) * trackRadius, ai.angle + Math.PI / 2, ai.color);

  // Мини-карта
  drawMiniMap();
}

function drawCar(x, y, angle, color) {
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(angle);
  ctx.fillStyle = color;
  ctx.fillRect(-8, -4, 16, 8); // упрощённая машина
  ctx.restore();
}

function drawMiniMap() {
  const size = 120;
  const margin = 16;
  const scale = 0.15;

  // Фон мини-карты
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillRect(margin, margin, size, size);

  const mapCenterX = margin + size / 2;
  const mapCenterY = margin + size / 2;

  // Трасса на мини-карте
  ctx.strokeStyle = '#555';
  ctx.lineWidth = trackWidth * 2 * scale;
  ctx.beginPath();
  ctx.arc(mapCenterX, mapCenterY, trackRadius * scale, 0, Math.PI * 2);
  ctx.stroke();

  // Машины на мини-карте
  const px = mapCenterX + Math.cos(player.angle) * trackRadius * scale;
  const py = mapCenterY + Math.sin(player.angle) * trackRadius * scale;
  const ax = mapCenterX + Math.cos(ai.angle) * trackRadius * scale;
  const ay = mapCenterY + Math.sin(ai.angle) * trackRadius * scale;

  ctx.fillStyle = player.color;
  ctx.fillRect(px - 2, py - 2, 4, 4);
  ctx.fillStyle = ai.color;
  ctx.fillRect(ax - 2, ay - 2, 4, 4);

  // Старт
  ctx.fillStyle = '#ff0000';
  ctx.fillRect(mapCenterX + trackRadius * scale - 1, mapCenterY - 1, 2, 2);
}

</script>
</body>
</html>

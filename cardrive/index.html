<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Гонки</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body {
      overflow: hidden;
      background: #0d0d0d;
      touch-action: none;
      color: white;
    }
    #main-menu {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      z-index: 10;
    }
    #main-menu.hidden { display: none; }
    #main-menu h1 {
      font-size: 32px;
      margin-bottom: 40px;
      text-align: center;
      color: #4cc9f0;
    }
    .btn {
      width: 220px;
      height: 60px;
      margin: 12px 0;
      font-size: 20px;
      font-weight: bold;
      background: #4361ee;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover, .btn:active { background: #3a56d4; }
    #game-canvas {
      display: block;
    }
    #pause-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }
    #controls {
      position: absolute;
      bottom: 25px;
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 0 20px;
      z-index: 10;
    }
    .ctrl-btn {
      width: 85px;
      height: 85px;
      background: rgba(0, 180, 255, 0.85);
      border: none;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.92);
      color: #ffeb3b;
      padding: 20px 35px;
      border-radius: 16px;
      font-size: 28px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
      text-align: center;
      transition: opacity 0.3s;
      border: 2px solid #ffeb3b;
    }
    #mini-map {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 120px;
      height: 120px;
      z-index: 9;
      pointer-events: none;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
    }
    #speedometer {
      position: absolute;
      top: 20px;
      right: 20px; /* Перенесено в правый верхний угол */
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 26px;
      font-weight: bold;
      z-index: 10;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>

<div id="main-menu">
  <h1>ГОНКИ</h1>
  <button id="btn-start" class="btn">Начать гонку</button>
  <button id="btn-exit" class="btn">К списку игр</button>
</div>

<canvas id="game-canvas"></canvas>
<canvas id="mini-map"></canvas>
<button id="pause-btn">⏸</button>
<div id="speedometer">000 км/ч</div>
<div id="controls">
  <button id="btn-brake" class="ctrl-btn">Тормоз</button>
  <button id="btn-gas" class="ctrl-btn">Газ</button>
</div>
<div id="message">ФИНИШ!</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/loaders/GLTFLoader.js';

// Исправленный URL для возврата
const GAMES_INDEX_URL = 'https://sergeevich11-png.github.io/github.io/';

let state = 'main-menu';
let renderer, scene, camera, carModel;

// Физика из "Тест машинки (финал)"
const maxSpeedForward = 23.0;
const maxSpeedBackward = 3.9;
let currentSpeed = 0;
const approachRate = 0.25;
const clock = new THREE.Clock();

let isGas = false, isBrake = false;

// Гироскоп
let initialGamma = null;
let gamma = 0;
const handleOrientation = (e) => {
  if (e.gamma === null) return;
  gamma = e.gamma;
  if (initialGamma === null) initialGamma = e.gamma;
};

// Карта из "Гонки — 1 Круг"
const trackRadius = 65;
const trackWidth = 12;
const R_in = trackRadius - trackWidth / 2;
const R_out = trackRadius + trackWidth / 2;

function constrain(posX, posZ) {
  const d = Math.sqrt(posX * posX + posZ * posZ);
  let speedMul = 1;
  if (d < R_in) {
    const f = (R_in + 0.3) / d;
    posX *= f; posZ *= f;
    speedMul = 0.8;
  } else if (d > R_out) {
    const f = (R_out - 0.3) / d;
    posX *= f; posZ *= f;
    speedMul = 0.8;
  }
  return { x: posX, z: posZ, speedMul };
}

let passedMid = false;
let finished = false;

// Элементы DOM
const mainMenu = document.getElementById('main-menu');
const pauseBtn = document.getElementById('pause-btn');
const gasBtn = document.getElementById('btn-gas');
const brakeBtn = document.getElementById('btn-brake');
const messageEl = document.getElementById('message');
const speedometerEl = document.getElementById('speedometer');
const canvas = document.getElementById('game-canvas');
const miniMapCanvas = document.getElementById('mini-map');
const miniMapCtx = miniMapCanvas.getContext('2d');

// Обработчики кнопок
document.getElementById('btn-start').addEventListener('click', () => {
  mainMenu.classList.add('hidden');
  startGame();
});

document.getElementById('btn-exit').addEventListener('click', () => {
  window.location.href = GAMES_INDEX_URL;
});

pauseBtn.addEventListener('click', () => {
  if (state === 'playing') {
    state = 'paused';
    mainMenu.classList.remove('hidden');
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    document.getElementById('controls').style.display = 'none';
    speedometerEl.style.display = 'none';
    miniMapCanvas.style.display = 'none';
  }
});

const bindButton = (el, down, up) => {
  const downHandler = (e) => { e.preventDefault(); down(); };
  el.addEventListener('touchstart', downHandler, { passive: false });
  el.addEventListener('mousedown', downHandler);
  const end = () => up();
  el.addEventListener('touchend', end);
  el.addEventListener('mouseup', end);
  el.addEventListener('mouseleave', end);
};
bindButton(gasBtn, () => isGas = true, () => isGas = false);
bindButton(brakeBtn, () => isBrake = true, () => isBrake = false);

// Инициализация игры
function tryLockLandscape() {
  if (screen.orientation?.lock) {
    screen.orientation.lock('landscape').catch(() => {});
  }
}

function startGame() {
  state = 'playing';
  tryLockLandscape();

  initialGamma = null;
  gamma = 0;
  currentSpeed = 0;
  passedMid = false;
  finished = false;

  canvas.style.display = 'block';
  pauseBtn.style.display = 'block';
  document.getElementById('controls').style.display = 'flex';
  speedometerEl.style.display = 'block';
  miniMapCanvas.style.display = 'block';

  // Чистая сцена из "Тест машинки"
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb); // Небо

  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

  renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  updateRendererSize();

  // Асфальт (плоскость)
  const asphalt = new THREE.Mesh(
    new THREE.PlaneGeometry(100, 100),
    new THREE.MeshStandardMaterial({ color: 0x333333 })
  );
  asphalt.rotation.x = -Math.PI / 2;
  scene.add(asphalt);

  // Освещение
  scene.add(new THREE.AmbientLight(0x666666));
  const sun = new THREE.DirectionalLight(0xffffff, 1);
  sun.position.set(10, 20, 10);
  scene.add(sun);

  // Ориентиры (столбики)
  const poleMat = new THREE.MeshStandardMaterial();
  const poleGeo = new THREE.CylinderGeometry(0.3, 0.3, 3, 8);
  const addPole = (x, z, color) => {
    const pole = new THREE.Mesh(poleGeo, poleMat.clone());
    pole.material.color.set(color);
    pole.position.set(x, 1.5, z);
    scene.add(pole);
  };
  for (let x = -50; x <= 50; x += 10) addPole(x, -50, 0x00ff00);
  for (let x = -50; x <= 50; x += 10) addPole(x, 50, 0x8B4513);
  for (let z = -50; z <= 50; z += 10) addPole(-50, z, 0x9400d3);
  for (let z = -50; z <= 50; z += 10) addPole(50, z, 0xff69b4);

  // Загрузка модели
  const loader = new GLTFLoader();
  loader.load('model.glb', (gltf) => {
    carModel = gltf.scene;
    carModel.scale.set(0.05, 0.05, 0.05);
    carModel.rotation.y = Math.PI / 2;
    scene.add(carModel);
    resetCar();
  }, undefined, (error) => {
    console.error('Ошибка загрузки model.glb:', error);
    createFallbackCar();
    resetCar();
  });

  // Подписка на гироскоп
  if (typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission) {
    DeviceOrientationEvent.requestPermission().then(permission => {
      if (permission === 'granted') {
        window.addEventListener('deviceorientation', handleOrientation, { passive: true });
      }
    }).catch(console.warn);
  } else {
    window.addEventListener('deviceorientation', handleOrientation, { passive: true });
  }

  miniMapCanvas.width = 120;
  miniMapCanvas.height = 120;

  animate();
}

function createFallbackCar() {
  const group = new THREE.Group();
  const body = new THREE.Mesh(new THREE.BoxGeometry(2, 0.8, 4), new THREE.MeshPhongMaterial({ color: 0xff3333 }));
  group.add(body);
  const wheelGeo = new THREE.CylinderGeometry(0.6, 0.6, 0.4, 16);
  wheelGeo.rotateX(Math.PI / 2);
  const wheelMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
  const createWheel = (x, z) => {
    const w = new THREE.Mesh(wheelGeo, wheelMat);
    w.position.set(x, -0.6, z);
    return w;
  };
  group.add(createWheel(-1.1, -1.5));
  group.add(createWheel(1.1, -1.5));
  group.add(createWheel(-1.1, 1.5));
  group.add(createWheel(1.1, 1.5));
  carModel = group;
  scene.add(carModel);
}

function resetCar() {
  if (carModel) {
    carModel.position.set(0, 0.62, 0);
    carModel.rotation.y = Math.PI / 2;
  }
}

function updateRendererSize() {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize', () => { if (state === 'playing') updateRendererSize(); });

// Главный игровой цикл
function update() {
  const delta = Math.min(clock.getDelta(), 0.1);

  // Поворот (физика из теста)
  let steerAngle = 0;
  if (initialGamma !== null) {
    const deltaGamma = gamma - initialGamma;
    const deadZone = 0.35;
    if (Math.abs(deltaGamma) > deadZone) {
      const effective = Math.sign(deltaGamma) * (Math.abs(deltaGamma) - deadZone);
      const normalized = Math.min(1, Math.max(-1, effective / (25 - deadZone)));
      const steerInput = normalized * Math.abs(normalized);
      steerAngle = steerInput * (Math.PI / 4);
    }
  }

  // Ускорение/тормоз (физика из теста)
  if (isGas) {
    currentSpeed += (maxSpeedForward - currentSpeed) * (1 - Math.exp(-approachRate * delta));
  } else if (isBrake) {
    if (currentSpeed > 0.5) {
      currentSpeed -= 2.2 * delta * 60;
      if (currentSpeed < 0) currentSpeed = 0;
    }
    currentSpeed -= (maxSpeedBackward + currentSpeed) * (1 - Math.exp(-approachRate * 1.2 * delta));
    currentSpeed = Math.max(-maxSpeedBackward, currentSpeed);
  } else {
    currentSpeed *= Math.pow(0.94, delta * 60);
  }

  // Ограничение в поворотах
  const steerAbs = Math.abs(steerAngle / (Math.PI / 4));
  const effectiveMax = maxSpeedForward * (1 - 0.4 * steerAbs);
  if (currentSpeed > effectiveMax) currentSpeed = effectiveMax;

  // Поворот кузова
  if (Math.abs(currentSpeed) > 0.1 && Math.abs(steerAngle) > 0.01) {
    const turnRate = (Math.abs(currentSpeed) / maxSpeedForward) * 1.4;
    if (carModel) carModel.rotation.y -= steerAngle * turnRate * delta;
  }

  // Позиция + коллизия
  if (carModel) {
    const dir = new THREE.Vector3(0, 0, -1).applyEuler(carModel.rotation);
    carModel.position.x += dir.x * currentSpeed * delta;
    carModel.position.z += dir.z * currentSpeed * delta;

    const clamped = constrain(carModel.position.x, carModel.position.z);
    carModel.position.x = clamped.x;
    carModel.position.z = clamped.z;
    currentSpeed *= clamped.speedMul;
  }

  // Камера
  if (carModel) {
    const forward = new THREE.Vector3(0, 0, -1).applyEuler(carModel.rotation).normalize();
    camera.position.copy(carModel.position).add(forward.clone().multiplyScalar(-16));
    camera.position.y += 8;
    camera.lookAt(carModel.position.x, carModel.position.y + 1.5, carModel.position.z + forward.z * 5);
  }

  // Спидометр
  const absSpeed = Math.abs(currentSpeed * 10);
  speedometerEl.textContent = currentSpeed < -0.05
    ? `R ${absSpeed.toFixed(0).padStart(3, '0')} км/ч`
    : `${absSpeed.toFixed(0).padStart(3, '0')} км/ч`;

  // Мини-карта (из 1 КРУГА)
  miniMapCtx.clearRect(0, 0, 120, 120);
  const cx = 60, cy = 60, s = 0.8;
  miniMapCtx.strokeStyle = '#555';
  miniMapCtx.lineWidth = trackWidth * s;
  miniMapCtx.beginPath();
  miniMapCtx.arc(cx, cy, trackRadius * s, 0, Math.PI * 2);
  miniMapCtx.stroke();
  miniMapCtx.strokeStyle = '#ff0000';
  miniMapCtx.lineWidth = 3;
  miniMapCtx.beginPath();
  miniMapCtx.arc(cx, cy, trackRadius * s, -0.1, 0.1);
  miniMapCtx.stroke();
  if (carModel) {
    miniMapCtx.fillStyle = '#ff3333';
    miniMapCtx.fillRect(cx + carModel.position.x * s - 2, cy + carModel.position.z * s - 2, 4, 4);
  }
}

function animate() {
  if (state === 'playing') {
    update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
}

function showMessage(text) {
  messageEl.textContent = text;
  messageEl.style.opacity = '1';
  state = 'finished';
  setTimeout(() => {
    messageEl.style.opacity = '0';
    mainMenu.classList.remove('hidden');
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    document.getElementById('controls').style.display = 'none';
    speedometerEl.style.display = 'none';
    miniMapCanvas.style.display = 'none';
  }, 3000);
}
</script>
</body>
</html>

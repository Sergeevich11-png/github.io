<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Гонки — 1 Круг</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
    body {
      overflow: hidden;
      background: #000;
      touch-action: none;
      color: white;
    }
    #screen {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
    }
    #screen.hidden { display: none; }
    #screen h1 {
      font-size: 32px;
      margin-bottom: 40px;
      text-align: center;
      color: #4cc9f0;
    }
    .btn {
      width: 220px;
      height: 60px;
      margin: 12px 0;
      font-size: 20px;
      font-weight: bold;
      background: #4361ee;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover, .btn:active { background: #3a56d4; }
    #game-canvas { display: block; }
    #pause-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }
    #controls {
      position: absolute;
      bottom: 25px;
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 0 20px;
      z-index: 10;
    }
    .ctrl-btn {
      width: 85px;
      height: 85px;
      background: rgba(0, 180, 255, 0.85);
      border: none;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px 35px;
      border-radius: 16px;
      font-size: 28px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
      text-align: center;
    }
    #orientation-blocker {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #0d0d1a;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      color: #f8f9fa;
    }
    #orientation-blocker.active { display: flex; }
    #orientation-blocker p {
      font-size: 22px;
      text-align: center;
      max-width: 80%;
      margin-bottom: 30px;
      line-height: 1.4;
    }
    #orientation-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<!-- ОСНОВНОЕ МЕНЮ (ПОРТРЕТ) -->
<div id="main-menu" class="screen">
  <h1>ГОНКИ: 1 КРУГ</h1>
  <button id="btn-start" class="btn">1 круг</button>
  <button id="btn-exit" class="btn">Выход</button>
</div>

<!-- БЛОКИРОВКА ПРИ НЕПРАВИЛЬНОЙ ОРИЕНТАЦИИ -->
<div id="orientation-blocker">
  <div id="orientation-icon">↔️</div>
  <p>Поверните устройство в альбомную ориентацию для начала гонки</p>
</div>

<!-- ИГРОВОЙ ЭКРАН -->
<canvas id="game-canvas"></canvas>
<button id="pause-btn">≡</button>
<div id="controls">
  <button id="btn-brake" class="ctrl-btn">Тормоз</button>
  <button id="btn-gas" class="ctrl-btn">Газ</button>
</div>
<div id="message">ФИНИШ!</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js';

// === СОСТОЯНИЯ ===
let state = 'main-menu'; // 'main-menu', 'playing', 'paused'
let renderer, scene, camera;
let playerCar, aiCar;
let speed = 0;
let isGas = false, isBrake = false;
let targetSteering = 0, currentSteering = 0;
let raceStarted = false;
let playerLap = 0, aiLap = 0;
let playerFinished = false, aiFinished = false;
let barriers = [];
let trackRadius = 65;
let trackWidth = 10;
let aiSpeed = 0, aiTargetSpeed = 0;

// === DOM ===
const mainMenu = document.getElementById('main-menu');
const blocker = document.getElementById('orientation-blocker');
const pauseBtn = document.getElementById('pause-btn');
const gasBtn = document.getElementById('btn-gas');
const brakeBtn = document.getElementById('btn-brake');
const messageEl = document.getElementById('message');
const canvas = document.getElementById('game-canvas');

// === КНОПКИ ===
document.getElementById('btn-start').addEventListener('click', () => {
  mainMenu.classList.add('hidden');
  blocker.classList.add('active');
  checkOrientation();
});

document.getElementById('btn-exit').addEventListener('click', () => {
  // ЗАМЕНИ НА СВОЙ URL МЕНЮ ВЫБОРА ИГР!
  window.location.href = 'https://anu-games.github.io/';
});

pauseBtn.addEventListener('click', () => {
  if (state === 'playing') {
    state = 'paused';
    mainMenu.classList.remove('hidden');
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    document.getElementById('controls').style.display = 'none';
  }
});

// Управление газ/тормоз
const bindButton = (el, down, up) => {
  el.addEventListener('touchstart', down);
  el.addEventListener('mousedown', down);
  const end = () => { up(); };
  el.addEventListener('touchend', end);
  el.addEventListener('mouseup', end);
  el.addEventListener('mouseleave', end);
};
bindButton(gasBtn, () => isGas = true, () => isGas = false);
bindButton(brakeBtn, () => isBrake = true, () => isBrake = false);

// === ПРОВЕРКА ОРИЕНТАЦИИ ===
function checkOrientation() {
  const isLandscape = window.innerWidth > window.innerHeight;
  if (isLandscape && state !== 'playing') {
    blocker.classList.remove('active');
    startGame();
  } else {
    setTimeout(checkOrientation, 300);
  }
}

window.addEventListener('resize', () => {
  if (state === 'playing') {
    updateRendererSize();
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
  } else {
    checkOrientation();
  }
});

// === ЗАПУСК ИГРЫ ===
function startGame() {
  if (state === 'playing') return;
  state = 'playing';

  // Убираем меню
  canvas.style.display = 'block';
  pauseBtn.style.display = 'block';
  document.getElementById('controls').style.display = 'flex';

  // Инициализация Three.js
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);

  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 12, -10);

  renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  updateRendererSize();

  // === ТРЕССА (кольцо) ===
  const roadGroup = new THREE.Group();
  const roadGeo = new THREE.RingGeometry(
    trackRadius - trackWidth / 2,
    trackRadius + trackWidth / 2,
    128
  );
  const roadMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.9 });
  const road = new THREE.Mesh(roadGeo, roadMat);
  road.rotation.x = Math.PI / 2;
  roadGroup.add(road);
  scene.add(roadGroup);

  // === СТАРТ/ФИНИШ ===
  const startLine = new THREE.Mesh(
    new THREE.PlaneGeometry(trackWidth, 1.5),
    new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.7 })
  );
  startLine.rotation.x = Math.PI / 2;
  startLine.position.set(trackRadius, 0, 0);
  scene.add(startLine);

  // === ОТБОЙНИКИ ===
  barriers = [];
  const createBarrier = (x, z) => {
    barriers.push({ x, z, radius: 1.2 });
  };
  const steps = 80;
  for (let i = 0; i < steps; i++) {
    const angle = (i / steps) * Math.PI * 2;
    createBarrier(
      Math.cos(angle) * (trackRadius + trackWidth / 2 + 0.8),
      Math.sin(angle) * (trackRadius + trackWidth / 2 + 0.8)
    );
    createBarrier(
      Math.cos(angle) * (trackRadius - trackWidth / 2 - 0.8),
      Math.sin(angle) * (trackRadius - trackWidth / 2 - 0.8)
    );
  }

  // === АВТОМОБИЛИ ===
  playerCar = createCar(0xff3333);
  playerCar.position.set(trackRadius - 3, 0, 0);
  playerCar.rotation.y = Math.PI / 2;
  scene.add(playerCar);

  aiCar = createCar(0x33ff33);
  aiCar.position.set(trackRadius - 3, 0, 0);
  aiCar.rotation.y = Math.PI / 2;
  aiCar.position.x -= 5; // немного позади
  scene.add(aiCar);

  // === ОСВЕЩЕНИЕ ===
  scene.add(new THREE.AmbientLight(0x606060));
  const sun = new THREE.DirectionalLight(0xffffff, 1);
  sun.position.set(20, 40, 20);
  scene.add(sun);

  // === ГИРОСКОП ===
  if (typeof DeviceOrientationEvent !== 'undefined') {
    window.addEventListener('deviceorientation', handleOrientation, { passive: true });
    // iOS
    if (DeviceOrientationEvent.requestPermission) {
      DeviceOrientationEvent.requestPermission().catch(console.warn);
    }
  }

  // Сброс состояний
  speed = 0;
  aiSpeed = 0;
  raceStarted = false;
  playerLap = 0;
  aiLap = 0;
  playerFinished = false;
  aiFinished = false;

  animate();
}

function updateRendererSize() {
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function handleOrientation(e) {
  if (state !== 'playing') return;
  if (e.gamma !== null) {
    // gamma: -90..90 → поворот
    targetSteering = (e.gamma / 90) * 0.9;
  }
}

function createCar(color) {
  const group = new THREE.Group();
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(1.3, 0.55, 2.2),
    new THREE.MeshPhongMaterial({ color })
  );
  group.add(body);

  const windshield = new THREE.Mesh(
    new THREE.BoxGeometry(1.1, 0.35, 0.1),
    new THREE.MeshPhongMaterial({ color: 0x88ccff, transparent: true, opacity: 0.6 })
  );
  windshield.position.set(0, 0.28, -0.65);
  group.add(windshield);

  const wheelGeo = new THREE.CylinderGeometry(0.32, 0.32, 0.22, 16);
  wheelGeo.rotateZ(Math.PI / 2);
  const wheelMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
  const addWheel = (x, z) => {
    const w = new THREE.Mesh(wheelGeo, wheelMat);
    w.position.set(x, -0.32, z);
    group.add(w);
  };
  addWheel(0.75, 0.9);
  addWheel(-0.75, 0.9);
  addWheel(0.75, -0.9);
  addWheel(-0.75, -0.9);

  return group;
}

// === ЛОГИКА ИИ ===
function updateAI(delta) {
  if (aiFinished) return;

  const toCenter = new THREE.Vector3().subVectors(new THREE.Vector3(), aiCar.position).normalize();
  const targetAngle = Math.atan2(toCenter.z, toCenter.x) - Math.PI / 2;
  // Небольшой "шум" для реализма
  const noise = (Math.sin(Date.now() * 0.0007) * 0.3);
  let desiredRot = targetAngle + noise;

  // Поворот
  let rotDiff = desiredRot - aiCar.rotation.y;
  // Нормализация угла
  while (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
  while (rotDiff < -Math.PI) rotDiff += Math.PI * 2;
  aiCar.rotation.y += Math.max(-0.1, Math.min(0.1, rotDiff * 3)) * delta * 10;

  // Скорость
  aiTargetSpeed = 28 + Math.sin(Date.now() * 0.001) * 4;
  aiSpeed += (aiTargetSpeed - aiSpeed) * 2 * delta;
  aiSpeed = Math.max(0, Math.min(aiSpeed, 38));

  // Движение
  aiCar.position.x += Math.cos(aiCar.rotation.y) * aiSpeed * delta;
  aiCar.position.z += Math.sin(aiCar.rotation.y) * aiSpeed * delta;

  // Проверка круга ИИ
  const angle = Math.atan2(aiCar.position.z, aiCar.position.x);
  if (!raceStarted && Math.abs(angle) < 0.2 && aiCar.position.x > trackRadius - 5) {
    raceStarted = true;
  }
  if (raceStarted && aiLap === 0 && Math.abs(angle) < 0.2 && aiCar.position.x > trackRadius - 5) {
    aiLap = 1;
    aiFinished = true;
    if (!playerFinished) showMessage("ИИ пришёл первым!");
  }
}

// === СТОЛКНОВЕНИЯ ===
function checkCollisions() {
  // Игрок ↔ ИИ
  const dx = playerCar.position.x - aiCar.position.x;
  const dz = playerCar.position.z - aiCar.position.z;
  const dist = Math.sqrt(dx * dx + dz * dz);
  if (dist < 2.3) {
    speed *= 0.4;
    // Отталкивание
    const push = 1.8;
    playerCar.position.x += dx * push / dist;
    playerCar.position.z += dz * push / dist;
  }

  // Игрок ↔ отбойники
  for (const b of barriers) {
    const dx = playerCar.position.x - b.x;
    const dz = playerCar.position.z - b.z;
    const dist = Math.sqrt(dx * dx + dz * dz);
    if (dist < b.radius + 0.9) {
      speed *= 0.85;
      if (Math.abs(speed) > 1.5) speed *= 0.93; // трение → остановка
      const push = 0.6;
      playerCar.position.x += dx * push / dist;
      playerCar.position.z += dz * push / dist;
    }
  }
}

// === ОБНОВЛЕНИЕ КАМЕРЫ ===
function updateCamera() {
  if (!playerCar) return;
  camera.position.x = playerCar.position.x - Math.cos(playerCar.rotation.y) * 10;
  camera.position.z = playerCar.position.z - Math.sin(playerCar.rotation.y) * 10;
  camera.position.y = 8;
  camera.lookAt(playerCar.position.x, playerCar.position.y + 1, playerCar.position.z);
}

// === СООБЩЕНИЯ ===
function showMessage(text) {
  messageEl.textContent = text;
  messageEl.style.opacity = '1';
  setTimeout(() => messageEl.style.opacity = '0', 3000);
}

// === АНИМАЦИЯ ===
const clock = new THREE.Clock();

function animate() {
  if (state !== 'playing') return;

  const delta = Math.min(clock.getDelta(), 0.05);

  // Управление игроком
  currentSteering += (targetSteering - currentSteering) * 8 * delta;
  playerCar.rotation.y = currentSteering + Math.PI / 2;

  if (isGas) speed += 32 * delta;
  if (isBrake) speed -= 32 * delta;
  if (!isGas && !isBrake) speed *= 0.93;
  speed = Math.max(-28, Math.min(speed, 50));

  playerCar.position.x += Math.cos(playerCar.rotation.y) * speed * delta;
  playerCar.position.z += Math.sin(playerCar.rotation.y) * speed * delta;

  // ИИ и коллизии
  updateAI(delta);
  checkCollisions();

  // Проверка круга игрока
  const angle = Math.atan2(playerCar.position.z, playerCar.position.x);
  if (raceStarted && playerLap === 0 && Math.abs(angle) < 0.2 && playerCar.position.x > trackRadius - 5) {
    playerLap = 1;
    playerFinished = true;
    if (!aiFinished) showMessage("Вы победили!");
  }

  updateCamera();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
</script>
</body>
</html>

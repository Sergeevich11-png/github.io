<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR с экрана</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      font-size: 1.4em;
      margin-bottom: 20px;
    }
    input[type="file"] {
      margin: 15px 0;
    }
    #result {
      margin-top: 20px;
      word-break: break-all;
      padding: 10px;
      background: white;
      border-radius: 8px;
      display: none;
    }
    .btn {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
    }
    .btn:hover {
      opacity: 0.9;
    }
    #preview {
      max-width: 100%;
      max-height: 300px;
      margin-top: 15px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>QR с экрана</h1>
  <p>Выберите скриншот с QR-кодом</p>
  <input type="file" id="imageInput" accept="image/*">
  <div id="preview"></div>
  <div id="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const input = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const resultDiv = document.getElementById('result');

    input.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      const img = new Image();
      img.src = url;
      img.onload = () => {
        URL.revokeObjectURL(url);

        // Показать превью
        preview.innerHTML = '';
        preview.style.display = 'block';
        preview.appendChild(img);

        // Создаём canvas для анализа
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, img.width, img.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        resultDiv.style.display = 'block';
        if (code) {
          resultDiv.innerHTML = `
            <p><strong>Найдена ссылка:</strong></p>
            <p>${code.data}</p>
            <button class="btn" onclick="openLink('${code.data.replace(/'/g, "\\'")}')">Перейти</button>
          `;
        } else {
          resultDiv.innerHTML = '<p>QR-код не найден. Убедитесь, что он чёткий и полностью в кадре.</p>';
        }
      };
    });

    function openLink(url) {
      if (url.startsWith('http://') || url.startsWith('https://')) {
        window.open(url, '_blank');
      } else {
        alert('Ссылка не начинается с http/https. Открывать нельзя.');
      }
    }
  </script>
</body>
</html>

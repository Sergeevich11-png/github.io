<script>
  const translations = {
    ru: {
      title: "–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ",
      attempts: "–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫:",
      win: "üéâ –ü–æ–±–µ–¥–∞!",
      lose: "–ü—Ä–æ–∏–≥—Ä—ã—à! –ó–∞–≥–∞–¥–∞–Ω–æ:",
      allLevels: "üèÜ –í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!",
      nextBtn: "–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å",
      retryBtn: "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ",
      menuBtn: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é"
    },
    en: {
      title: "Guess the Number",
      attempts: "Attempts left:",
      win: "üéâ Victory!",
      lose: "Game over! The number was:",
      allLevels: "üèÜ All levels completed!",
      nextBtn: "Next level",
      retryBtn: "Start over",
      menuBtn: "Back to menu"
    }
  };

  let currentLang = localStorage.getItem('lang') || 'ru';
  const langBtn = document.getElementById('lang-btn');
  const menuBtn = document.getElementById('menu-btn');

  function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('lang', lang);
    langBtn.textContent = lang === 'ru' ? 'üá∑üá∫' : 'üåé';
    updateTexts();
  }

  function updateTexts() {
    const t = translations[currentLang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('attempts').innerHTML = `${t.attempts} <span id="count">${attemptsLeft}</span>`;
    document.getElementById('next-btn').textContent = t.nextBtn;
    document.getElementById('retry-btn').textContent = t.retryBtn;
    menuBtn.textContent = t.menuBtn;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
    const msgDiv = document.getElementById('message');
    const msg = msgDiv.textContent.trim();
    if (msg === secretNumber.toString()) {
      // —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –æ—Ç–≤–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    } else if (msg.includes('üéâ')) {
      msgDiv.textContent = t.win;
    } else if (msg.includes('üèÜ')) {
      msgDiv.textContent = t.allLevels;
    } else if (msg.includes('–ó–∞–≥–∞–¥–∞–Ω–æ:') || msg.includes('The number was:')) {
      msgDiv.textContent = `${t.lose} ${secretNumber}`;
    }
  }

  langBtn.onclick = () => {
    setLanguage(currentLang === 'ru' ? 'en' : 'ru');
  };

  menuBtn.onclick = () => {
    window.location.href = '../index.html';
  };

  // –£—Ä–æ–≤–Ω–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä
  const LEVELS = [2, 3, 4, 5]; // digits per level

  let currentLevel = 0;
  let secretNumber = '';
  const TOTAL_ATTEMPTS = 10;
  let attemptsLeft = TOTAL_ATTEMPTS;
  let input = [];
  let disabledDigits = new Set();
  let confirmedDigits = new Set();
  let revealed = [];

  function resetGame() {
    currentLevel = 0;
    attemptsLeft = TOTAL_ATTEMPTS;
    initLevel();
  }

  function initLevel() {
    const digits = LEVELS[currentLevel];
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–∏—Å–ª–∞: –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ ‚â† 0
    let firstDigit = Math.floor(Math.random() * 9) + 1;
    let rest = '';
    for (let i = 1; i < digits; i++) {
      rest += Math.floor(Math.random() * 10);
    }
    secretNumber = firstDigit + rest;
    
    revealed = Array(digits).fill(null);
    input = Array(digits).fill(null);
    disabledDigits.clear();
    confirmedDigits.clear();
    
    renderAll();
    document.getElementById('message').textContent = '';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('retry-btn').style.display = 'none';
    updateTexts(); // –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å–∏ –∏ —Å—á—ë—Ç—á–∏–∫
  }

  function renderAll() {
    renderSecret();
    renderInput();
    renderKeyboard();
  }

  function renderSecret() {
    const container = document.getElementById('secret');
    container.innerHTML = '';
    for (let i = 0; i < revealed.length; i++) {
      const box = document.createElement('div');
      box.className = 'digit-box ' + (revealed[i] === null ? 'hidden' : '');
      box.textContent = revealed[i] || '?';
      container.appendChild(box);
    }
  }

  function renderInput() {
    const container = document.getElementById('input');
    container.innerHTML = '';
    for (let i = 0; i < input.length; i++) {
      const box = document.createElement('div');
      if (revealed[i] !== null) {
        box.className = 'input-digit fixed';
        box.textContent = revealed[i];
        input[i] = revealed[i];
      } else {
        box.className = 'input-digit';
        box.textContent = input[i] || '';
      }
      container.appendChild(box);
    }
  }

  function renderKeyboard() {
    const container = document.getElementById('keyboard');
    container.innerHTML = '';
    for (let d = 0; d <= 9; d++) {
      const digitStr = String(d);
      const btn = document.createElement('div');
      btn.className = 'key';
      if (disabledDigits.has(digitStr)) {
        btn.classList.add('disabled');
      } else if (confirmedDigits.has(digitStr)) {
        btn.classList.add('confirmed');
      }
      btn.textContent = d;
      if (!disabledDigits.has(digitStr) && !confirmedDigits.has(digitStr)) {
        btn.onclick = () => handleKeyClick(d);
      }
      container.appendChild(btn);
    }
  }

  function handleKeyClick(digit) {
    const digitStr = String(digit);
    let inserted = false;
    for (let i = 0; i < input.length; i++) {
      if (revealed[i] === null && input[i] === null) {
        input[i] = digitStr;
        inserted = true;
        break;
      }
    }
    if (inserted) {
      renderInput();
      if (input.every(x => x !== null)) {
        processGuess();
      }
    }
  }

  function processGuess() {
    const guess = input.join('');

    for (const d of new Set(guess)) {
      if (secretNumber.includes(d)) {
        confirmedDigits.add(d);
        for (let i = 0; i < secretNumber.length; i++) {
          if (secretNumber[i] === d) {
            revealed[i] = d;
          }
        }
      } else {
        disabledDigits.add(d);
      }
    }

    for (let i = 0; i < input.length; i++) {
      if (revealed[i] === null) {
        input[i] = null;
      }
    }

    renderAll();

    // –ü–æ–±–µ–¥–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ
    if (revealed.every(d => d !== null)) {
      const t = translations[currentLang];
      document.getElementById('message').textContent = t.win;
      
      if (currentLevel < LEVELS.length - 1) {
        document.getElementById('next-btn').style.display = 'inline-block';
        document.getElementById('next-btn').onclick = () => {
          currentLevel++;
          initLevel();
        };
      } else {
        // –í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        document.getElementById('message').textContent = t.allLevels;
        document.getElementById('retry-btn').style.display = 'inline-block';
        document.getElementById('retry-btn').onclick = resetGame;
      }
      return;
    }

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞
    attemptsLeft--;
    document.getElementById('count').textContent = attemptsLeft;

    // –ü—Ä–æ–∏–≥—Ä—ã—à ‚Äî –∫–æ–Ω—á–∏–ª–∏—Å—å –ø–æ–ø—ã—Ç–∫–∏
    if (attemptsLeft <= 0) {
      const t = translations[currentLang];
      document.getElementById('message').textContent = `${t.lose} ${secretNumber}`;
      document.getElementById('retry-btn').style.display = 'inline-block';
      document.getElementById('retry-btn').onclick = resetGame;
    }
  }

  // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã
  setLanguage(currentLang);
  resetGame(); // –Ω–∞—á–∏–Ω–∞–µ–º —Å –Ω–∞—á–∞–ª–∞ –∏ 10 –ø–æ–ø—ã—Ç–∫–∞–º–∏
</script>
